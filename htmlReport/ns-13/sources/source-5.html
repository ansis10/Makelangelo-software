


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LoadScratch2</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.marginallyclever.makelangelo.makeart.io</a>
</div>

<h1>Coverage Summary for Class: LoadScratch2 (com.marginallyclever.makelangelo.makeart.io)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LoadScratch2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/49)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/182)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/393)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LoadScratch2$Scratch2List</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoadScratch2$Scratch2Variable</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/182)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/399)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.marginallyclever.makelangelo.makeart.io;
&nbsp;
&nbsp;import com.marginallyclever.makelangelo.turtle.Turtle;
&nbsp;import org.json.JSONArray;
&nbsp;import org.json.JSONObject;
&nbsp;import org.json.JSONTokener;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import javax.swing.filechooser.FileNameExtensionFilter;
&nbsp;import java.io.File;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.util.*;
&nbsp;import java.util.zip.ZipEntry;
&nbsp;import java.util.zip.ZipInputStream;
&nbsp;
&nbsp;/**
&nbsp; * LoadAndSaveSB2 loads limited set of Scratch commands into memory. 
&nbsp; * @author Admin
&nbsp; */
<b class="nc">&nbsp;public class LoadScratch2 implements TurtleLoader {</b>
<b class="nc">&nbsp;	private static final Logger logger = LoggerFactory.getLogger(LoadScratch2.class);</b>
&nbsp;	
<b class="nc">&nbsp;	private final String PROJECT_JSON = &quot;project.json&quot;;</b>
&nbsp;	
&nbsp;	private static class Scratch2Variable {
&nbsp;		public String name;
&nbsp;		public double value;
&nbsp;
<b class="nc">&nbsp;		public Scratch2Variable(String arg0,float arg1) {</b>
<b class="nc">&nbsp;			name=arg0;</b>
<b class="nc">&nbsp;			value=arg1;</b>
&nbsp;		}
&nbsp;	};
&nbsp;	
&nbsp;	private static class Scratch2List {
&nbsp;		public String name;
&nbsp;		public ArrayList&lt;Double&gt; contents;
&nbsp;
<b class="nc">&nbsp;		public Scratch2List(String _name) {</b>
<b class="nc">&nbsp;			name=_name;</b>
<b class="nc">&nbsp;			contents=new ArrayList&lt;Double&gt;();</b>
&nbsp;		}
&nbsp;	};
&nbsp;	
<b class="nc">&nbsp;	private FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Scratch 2&quot;,&quot;SB2&quot;);</b>
&nbsp;	private Turtle turtle;
&nbsp;	private LinkedList&lt;Scratch2Variable&gt; scratchVariables;
&nbsp;	private LinkedList&lt;Scratch2List&gt; scratchLists;
<b class="nc">&nbsp;	private Map&lt;String,JSONArray&gt; subRoutines = new HashMap&lt;String,JSONArray&gt;();</b>
&nbsp;	private int indent;
&nbsp;	
&nbsp;	@Override
&nbsp;	public FileNameExtensionFilter getFileNameFilter() {
<b class="nc">&nbsp;		return filter;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public boolean canLoad(String filename) {
<b class="nc">&nbsp;		String filenameExtension = filename.substring(filename.lastIndexOf(&#39;.&#39;)).toUpperCase();;</b>
<b class="nc">&nbsp;		return filenameExtension.equalsIgnoreCase(&quot;.SB2&quot;);</b>
&nbsp;	}
&nbsp;	
&nbsp;	@Override
&nbsp;	public Turtle load(InputStream in) throws Exception {
<b class="nc">&nbsp;		logger.debug(&quot;Loading...&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		turtle = new Turtle();</b>
<b class="nc">&nbsp;		indent=0;</b>
&nbsp;		
<b class="nc">&nbsp;		JSONObject tree = getTreeFromInputStream(in);</b>
<b class="nc">&nbsp;		readScratchVariables(tree);</b>
<b class="nc">&nbsp;		readScratchLists(tree);</b>
&nbsp;
&nbsp;		// read the sketch(es)
&nbsp;		// look for the first child with a script
<b class="nc">&nbsp;		JSONArray scripts = getScripts(tree);</b>
<b class="nc">&nbsp;		logger.debug(&quot;found {} top level event scripts&quot;, scripts.length());</b>
&nbsp;
<b class="nc">&nbsp;		readAllSubroutines(scripts);</b>
<b class="nc">&nbsp;		findAndRunFromGreenFlag(scripts);</b>
&nbsp;		
<b class="nc">&nbsp;		logger.debug(&quot;finished scripts&quot;);</b>
&nbsp;
<b class="nc">&nbsp;		return turtle;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void findAndRunFromGreenFlag(JSONArray scripts) throws Exception {
&nbsp;		// extract known elements and convert them to turtle commands.
<b class="nc">&nbsp;		Iterator&lt;?&gt; scriptIter = scripts.iterator();</b>
&nbsp;		// find the first script with a green flag.
<b class="nc">&nbsp;		while( scriptIter.hasNext() ) {</b>
<b class="nc">&nbsp;			JSONArray scripts0 = (JSONArray)scriptIter.next();</b>
<b class="nc">&nbsp;			if( scripts0==null ) continue;</b>
<b class="nc">&nbsp;			JSONArray scripts02 = (JSONArray)scripts0.get(2);</b>
<b class="nc">&nbsp;			if( scripts02==null || scripts02.length()==0 ) continue;</b>
&nbsp;			// look inside the script at the first block, which gives the type.
<b class="nc">&nbsp;			Object scriptContents = scripts02.get(0);</b>
<b class="nc">&nbsp;			if( ( scriptContents instanceof JSONArray ) ) {</b>
<b class="nc">&nbsp;				Object scriptHead = ((JSONArray)scriptContents).get(0);</b>
&nbsp;				
<b class="nc">&nbsp;    			String firstType = (String)scriptHead;</b>
<b class="nc">&nbsp;				if(firstType.equals(&quot;whenGreenFlag&quot;)) {</b>
<b class="nc">&nbsp;					logger.debug(&quot;Found green flag script&quot;);</b>
<b class="nc">&nbsp;					parseScratchCode(scripts02);</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void readAllSubroutines(JSONArray scripts) {
&nbsp;		// extract known elements and convert them to turtle commands.
<b class="nc">&nbsp;		Iterator&lt;?&gt; scriptIter = scripts.iterator();</b>
&nbsp;		
<b class="nc">&nbsp;		while( scriptIter.hasNext() ) {</b>
<b class="nc">&nbsp;			JSONArray scripts0 = (JSONArray)scriptIter.next();</b>
<b class="nc">&nbsp;			if( scripts0==null ) continue;</b>
<b class="nc">&nbsp;			JSONArray scripts02 = (JSONArray)scripts0.get(2);</b>
<b class="nc">&nbsp;			if( scripts02==null || scripts02.length()==0 ) continue;</b>
&nbsp;			// look inside the script at the first block, which gives the type.
<b class="nc">&nbsp;			Object scriptContents = scripts02.get(0);</b>
<b class="nc">&nbsp;			if( ( scriptContents instanceof JSONArray ) ) {</b>
<b class="nc">&nbsp;				String firstType = ((JSONArray)scriptContents).getString(0);</b>
<b class="nc">&nbsp;				if(firstType.equals(&quot;whenIReceive&quot;)) {</b>
<b class="nc">&nbsp;	    			String firstName = (String)((JSONArray)scriptContents).get(1);</b>
<b class="nc">&nbsp;					logger.debug(&quot;Found subroutine {}&quot;, firstName);</b>
<b class="nc">&nbsp;	    			subRoutines.put(firstName, ((JSONArray)scriptContents));</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private JSONArray getScripts(JSONObject tree) throws Exception {
<b class="nc">&nbsp;		Iterator&lt;?&gt; childIter = tree.getJSONArray(&quot;children&quot;).iterator();</b>
<b class="nc">&nbsp;		while( childIter.hasNext() ) {</b>
<b class="nc">&nbsp;			JSONObject child = (JSONObject)childIter.next();</b>
<b class="nc">&nbsp;			if(child.has(&quot;scripts&quot;)) {</b>
<b class="nc">&nbsp;				return (JSONArray)child.get(&quot;scripts&quot;);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		throw new Exception(&quot;JSON node &#39;scripts&#39; missing.&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private JSONObject getTreeFromInputStream(InputStream in) throws FileNotFoundException, IOException {
<b class="nc">&nbsp;		File tempZipFile = extractProjectJSON(in);</b>
&nbsp;		
<b class="nc">&nbsp;        logger.debug(&quot;Parsing JSON file...&quot;);</b>
<b class="nc">&nbsp;        JSONTokener tokener = new JSONTokener(tempZipFile.toURI().toURL().openStream());</b>
<b class="nc">&nbsp;        JSONObject tree = new JSONObject(tokener);</b>
&nbsp;
<b class="nc">&nbsp;		tempZipFile.delete();</b>
&nbsp;		
<b class="nc">&nbsp;		return tree;</b>
&nbsp;	}
&nbsp;
&nbsp;	private File extractProjectJSON(InputStream in) throws FileNotFoundException, IOException {
<b class="nc">&nbsp;		logger.debug(&quot;Searching for project.json...&quot;);</b>
<b class="nc">&nbsp;		try (ZipInputStream zipInputStream = new ZipInputStream(in)) {</b>
&nbsp;			ZipEntry entry;
<b class="nc">&nbsp;			while ((entry = zipInputStream.getNextEntry()) != null) {</b>
<b class="nc">&nbsp;				if (entry.getName().equals(PROJECT_JSON)) {</b>
<b class="nc">&nbsp;					logger.debug(&quot;Found.&quot;);</b>
&nbsp;
&nbsp;					// read buffered stream into temp file.
<b class="nc">&nbsp;					File tempZipFile = File.createTempFile(&quot;project&quot;, &quot;json&quot;);</b>
<b class="nc">&nbsp;					tempZipFile.setReadable(true);</b>
<b class="nc">&nbsp;					tempZipFile.setWritable(true);</b>
<b class="nc">&nbsp;					tempZipFile.deleteOnExit();</b>
<b class="nc">&nbsp;					try (FileOutputStream fos = new FileOutputStream(tempZipFile)) {</b>
<b class="nc">&nbsp;						byte[] buffer = new byte[2048];</b>
&nbsp;						int len;
<b class="nc">&nbsp;						while ((len = zipInputStream.read(buffer)) &gt; 0) {</b>
<b class="nc">&nbsp;							fos.write(buffer, 0, len);</b>
&nbsp;						}
<b class="nc">&nbsp;						return tempZipFile;</b>
<b class="nc">&nbsp;					}</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		throw new FileNotFoundException(&quot;SB2 missing project.json&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * read the list of Scratch variables
&nbsp;	 * @param tree the JSONObject tree read from the project.json/zip file.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private void readScratchVariables(JSONObject tree) throws Exception {
<b class="nc">&nbsp;		scratchVariables = new LinkedList&lt;Scratch2Variable&gt;();</b>
<b class="nc">&nbsp;		JSONArray variables = (JSONArray)tree.get(&quot;variables&quot;);</b>
&nbsp;		// A scratch file without variables would crash before this test
<b class="nc">&nbsp;		if (variables != null) {</b>
<b class="nc">&nbsp;			Iterator&lt;?&gt; varIter = variables.iterator();</b>
<b class="nc">&nbsp;			while( varIter.hasNext() ) {</b>
&nbsp;				//logger.debug(&quot;var:&quot;+elem.toString());
<b class="nc">&nbsp;				JSONObject elem = (JSONObject)varIter.next();</b>
<b class="nc">&nbsp;				String varName = elem.getString(&quot;name&quot;);</b>
<b class="nc">&nbsp;				Object varValue = elem.get(&quot;value&quot;);</b>
&nbsp;				float value;
<b class="nc">&nbsp;				if(varValue instanceof Number) {</b>
<b class="nc">&nbsp;					Number num = (Number)varValue;</b>
<b class="nc">&nbsp;					value = (float)num.doubleValue();</b>
<b class="nc">&nbsp;					scratchVariables.add(new Scratch2Variable(varName, value));</b>
<b class="nc">&nbsp;				} else if(varValue instanceof String) {</b>
&nbsp;					try {
<b class="nc">&nbsp;						value = Float.parseFloat((String)varValue);</b>
<b class="nc">&nbsp;	    				scratchVariables.add(new Scratch2Variable(varName, value));</b>
<b class="nc">&nbsp;					} catch (Exception e) {</b>
<b class="nc">&nbsp;						throw new Exception(&quot;Variables must be numbers.&quot;, e);</b>
&nbsp;					}
<b class="nc">&nbsp;				} else throw new Exception(&quot;Variable &quot;+varName+&quot; is &quot;+varValue.toString());</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * read the list of Scratch lists
&nbsp;	 * @param tree the JSONObject tree read from the project.json/zip file.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private void readScratchLists(JSONObject tree) throws Exception {
<b class="nc">&nbsp;		scratchLists = new LinkedList&lt;Scratch2List&gt;();</b>
<b class="nc">&nbsp;		JSONArray listOfLists = (JSONArray)tree.get(&quot;lists&quot;);</b>
<b class="nc">&nbsp;		if(listOfLists == null) return;</b>
<b class="nc">&nbsp;		logger.debug(&quot;Found {} lists.&quot;, listOfLists.length());</b>
<b class="nc">&nbsp;		Iterator&lt;?&gt; listIter = listOfLists.iterator();</b>
<b class="nc">&nbsp;		while( listIter.hasNext() ) {</b>
&nbsp;			//logger.debug(&quot;var:&quot;+elem.toString());
<b class="nc">&nbsp;			JSONObject elem = (JSONObject)listIter.next();</b>
<b class="nc">&nbsp;			String listName = (String)elem.get(&quot;listName&quot;);</b>
<b class="nc">&nbsp;			logger.debug(&quot;  Found list {}&quot;, listName);</b>
<b class="nc">&nbsp;			Object contents = elem.get(&quot;contents&quot;);</b>
<b class="nc">&nbsp;			Scratch2List list = new Scratch2List(listName);</b>
&nbsp;			// fill the list with any given contents
<b class="nc">&nbsp;			if( contents != null &amp;&amp; contents instanceof JSONArray ) {</b>
<b class="nc">&nbsp;				JSONArray arr = (JSONArray)contents;</b>
&nbsp;
<b class="nc">&nbsp;				Iterator&lt;?&gt; scriptIter = arr.iterator();</b>
<b class="nc">&nbsp;				while(scriptIter.hasNext()) {</b>
<b class="nc">&nbsp;					Object varValue = scriptIter.next();</b>
&nbsp;					double value;
<b class="nc">&nbsp;					if(varValue instanceof Number) {</b>
<b class="nc">&nbsp;						Number num = (Number)varValue;</b>
<b class="nc">&nbsp;						value = num.doubleValue();</b>
<b class="nc">&nbsp;						list.contents.add(value);</b>
<b class="nc">&nbsp;					} else if(varValue instanceof String) {</b>
&nbsp;						try {
<b class="nc">&nbsp;							value = Float.parseFloat((String)varValue);</b>
<b class="nc">&nbsp;							list.contents.add(value);</b>
<b class="nc">&nbsp;						} catch (Exception e) {</b>
<b class="nc">&nbsp;							throw new Exception(&quot;List variables must be numbers.&quot;, e);</b>
&nbsp;						}
<b class="nc">&nbsp;					} else throw new Exception(&quot;List variable &quot;+listName+&quot;(&quot;+list.contents.size()+&quot;) is &quot;+varValue.toString());</b>
&nbsp;				}
&nbsp;			}
&nbsp;			// add the list to the list-of-lists.
<b class="nc">&nbsp;			scratchLists.add(list);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	private int getListByID(Object obj) throws Exception {
<b class="nc">&nbsp;		if(!(obj instanceof String)) throw new Exception(&quot;List name not a string.&quot;);</b>
<b class="nc">&nbsp;		String listName = obj.toString();</b>
<b class="nc">&nbsp;		ListIterator&lt;Scratch2List&gt; iter = scratchLists.listIterator();</b>
<b class="nc">&nbsp;		int index=0;</b>
<b class="nc">&nbsp;		while(iter.hasNext()) {</b>
<b class="nc">&nbsp;			Scratch2List i = iter.next();</b>
<b class="nc">&nbsp;			if(i.name.equals(listName)) return index;</b>
<b class="nc">&nbsp;			++index;</b>
&nbsp;		}
<b class="nc">&nbsp;		throw new Exception(&quot;List &#39;&quot;+listName+&quot;&#39; not found.&quot;);</b>
&nbsp;	}
&nbsp;	
&nbsp;	private String getIndent() {
<b class="nc">&nbsp;		String str=&quot;&quot;;</b>
<b class="nc">&nbsp;		for(int j=0;j&lt;indent;++j) str+=&quot;  &quot;;</b>
<b class="nc">&nbsp;		return str;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * read the elements of a JSON array describing Scratch code and parse it into turtle commands.
&nbsp;	 * @param script valid JSONArray of Scratch commands.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private void parseScratchCode(JSONArray script) throws Exception {
<b class="nc">&nbsp;		if(script==null) return;</b>
&nbsp;		
&nbsp;		//logger.debug(getIndent()+&quot;{&quot;);  //&quot;[size=&quot;+script.size()+&quot;]&quot;
<b class="nc">&nbsp;		indent++;</b>
&nbsp;		
<b class="nc">&nbsp;		Iterator&lt;?&gt; scriptIter = script.iterator();</b>
&nbsp;		// Find the script with the green flag.  Assumes only one green flag per script.
<b class="nc">&nbsp;		while( scriptIter.hasNext() ) {</b>
<b class="nc">&nbsp;			Object o = scriptIter.next();</b>
<b class="nc">&nbsp;			if( o instanceof JSONArray ) {</b>
<b class="nc">&nbsp;				JSONArray arr = (JSONArray)o;</b>
<b class="nc">&nbsp;				parseScratchCode(arr);</b>
&nbsp;				continue;
&nbsp;			}
<b class="nc">&nbsp;			String name = o.toString();</b>
&nbsp;			//logger.debug(getIndent()+name);
<b class="nc">&nbsp;			switch(name) {</b>
<b class="nc">&nbsp;			case &quot;whenIReceive&quot;-&gt;		scriptIter.next();</b>
<b class="nc">&nbsp;			case &quot;doBroadcastAndWait&quot;-&gt; doBroadcastAndWait(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;doRepeat&quot;-&gt; 			doRepeat(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;doUntil&quot;-&gt; 			doUntil(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;doIf&quot;-&gt; 				doIf(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;doIfElse&quot;-&gt; 			doIfElse(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;append:toList:&quot;-&gt; 	doAppend(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;deleteLine:ofList:&quot;-&gt; doDeleteLine(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;insert:at:ofList:&quot;-&gt; 	doInsertLine(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;setLine:ofList:to:&quot;-&gt; doSetLine(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;wait:elapsed:from:&quot;-&gt; doWait(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;putPenUp&quot;-&gt; 			turtle.penUp();</b>
<b class="nc">&nbsp;			case &quot;putPenDown&quot;-&gt; 		turtle.penDown();</b>
<b class="nc">&nbsp;			case &quot;gotoX:y:&quot;-&gt;			doGotoXY(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;changeXposBy:&quot;-&gt; 		doChangeX(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;changeYposBy:&quot;-&gt; 		doChangeY(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;forward:&quot;-&gt; 			doForward(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;turnRight:&quot;-&gt; 		doTurnRight(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;turnLeft:&quot;-&gt; 			doTurnLeft(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;xpos:&quot;-&gt; 				doSetX(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;ypos:&quot;-&gt; 				doSetY(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;heading:&quot;-&gt; 			doSetHeading(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;setVar:to:&quot;-&gt; 		doSetVar(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;changeVar:by:&quot;-&gt; 		doChangeVar(scriptIter);</b>
<b class="nc">&nbsp;			default-&gt;					logger.debug(&quot;Ignored Scratch block &quot;+name);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		indent--;</b>
&nbsp;		//logger.debug(getIndent()+&quot;}&quot;);
&nbsp;	}
&nbsp;
&nbsp;	// relative change
&nbsp;	private void doChangeVar(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		String varName = (String)scriptIter.next();</b>
<b class="nc">&nbsp;		float v = (float)resolveValue(scriptIter.next());</b>
&nbsp;
<b class="nc">&nbsp;		for(Scratch2Variable sv : scratchVariables) {</b>
<b class="nc">&nbsp;			if(sv.name.equals(varName)) {</b>
<b class="nc">&nbsp;				sv.value += v;</b>
&nbsp;				//logger.debug(getIndent()+&quot;Change &quot;+varName+&quot; by &quot;+v+&quot; to &quot;+sv.value);
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		throw new Exception(&quot;Variable &#39;&quot;+varName+&quot;&#39; not found.&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	// absolute change
&nbsp;	private void doSetVar(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		String varName = (String)scriptIter.next();</b>
<b class="nc">&nbsp;		float v = (float)resolveValue(scriptIter.next());</b>
&nbsp;
<b class="nc">&nbsp;		for(Scratch2Variable sv : scratchVariables) {</b>
<b class="nc">&nbsp;			if(sv.name.equals(varName)) {</b>
<b class="nc">&nbsp;				sv.value = v;</b>
&nbsp;				//logger.debug(getIndent()+&quot;Set &quot;+varName+&quot; to &quot;+v);
&nbsp;				return;
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		throw new Exception(&quot;Variable &#39;&quot;+varName+&quot;&#39; not found.&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doSetHeading(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double degrees = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.setAngle(degrees);</b>
&nbsp;		//logger.debug(getIndent()+&quot;Turn to &quot;+degrees);
&nbsp;	}
&nbsp;
&nbsp;	private void doSetY(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double v = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.moveTo(turtle.getX(),v);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} Move to ({},{})&quot;, getIndent(), turtle.getX(), turtle.getY());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doSetX(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double v = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.moveTo(v,turtle.getY());</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} Move to ({},{})&quot;, getIndent(), turtle.getX(), turtle.getY());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doTurnLeft(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double degrees = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.turn(degrees);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} Left {} degrees.&quot;, getIndent(), degrees);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doTurnRight(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double degrees = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.turn(-degrees);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} Right {} degrees.&quot;, getIndent(), degrees);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doForward(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double v = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.forward(v);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} Move forward {} mm&quot;, getIndent(), v);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doChangeX(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double v = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.moveTo(turtle.getX()+v,turtle.getY());</b>
&nbsp;		//logger.debug(getIndent()+&quot;Move to (&quot;+turtle.getX()+&quot;,&quot;+turtle.getY()+&quot;)&quot;);		
&nbsp;	}
&nbsp;
&nbsp;	private void doChangeY(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double v = resolveValue(o2);</b>
<b class="nc">&nbsp;		turtle.moveTo(turtle.getX(),turtle.getY()+v);</b>
&nbsp;		//logger.debug(getIndent()+&quot;Move to (&quot;+turtle.getX()+&quot;,&quot;+turtle.getY()+&quot;)&quot;);		
&nbsp;	}
&nbsp;
&nbsp;	private void doGotoXY(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double x = resolveValue(o2);</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		double y = resolveValue(o3);</b>
<b class="nc">&nbsp;		turtle.moveTo(x,y);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{}Move to ({},{})&quot;, getIndent(), turtle.getX(), turtle.getY());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doWait(Iterator&lt;?&gt; scriptIter) throws Exception {
&nbsp;		// dwell - does nothing.
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		double seconds = resolveValue(o2);</b>
<b class="nc">&nbsp;		logger.debug(&quot;{} dwell {} seconds.&quot;, getIndent(), seconds);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doSetLine(Iterator&lt;?&gt; scriptIter) throws Exception {
&nbsp;		// &quot;setLine:ofList:to:&quot;, index, list name, new value
<b class="nc">&nbsp;		Object o4 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		double newValue = resolveValue(o4);</b>
<b class="nc">&nbsp;		int listIndex = (int)resolveListIndex(o2,o3);</b>
<b class="nc">&nbsp;		scratchLists.get(getListByID(o3)).contents.set(listIndex,newValue);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doInsertLine(Iterator&lt;?&gt; scriptIter) throws Exception {
&nbsp;		// &quot;insert:at:ofList:&quot;, new value, index, list name 
<b class="nc">&nbsp;		Object o4 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		double newValue = resolveValue(o4);</b>
<b class="nc">&nbsp;		int listIndex = (int)resolveListIndex(o2,o3);</b>
<b class="nc">&nbsp;		scratchLists.get(getListByID(o3)).contents.add(listIndex,newValue);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doDeleteLine(Iterator&lt;?&gt; scriptIter) throws Exception {
&nbsp;		// &quot;deleteLine:ofList:&quot;, index, list name 
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		int listIndex = (int)resolveListIndex(o2,o3);</b>
<b class="nc">&nbsp;		scratchLists.get(getListByID(o3)).contents.remove(listIndex);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doAppend(Iterator&lt;?&gt; scriptIter) throws Exception {
&nbsp;		// &quot;append:toList:&quot;, new value, list name 
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		double value = resolveValue(o2);</b>
<b class="nc">&nbsp;		scratchLists.get(getListByID(o3)).contents.add(value);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void doIfElse(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o4 = scriptIter.next();</b>
<b class="nc">&nbsp;		if(resolveBoolean((JSONArray)o2)) {</b>
&nbsp;			//logger.debug(getIndent()+&quot;if(true)&quot;);
<b class="nc">&nbsp;			parseScratchCode((JSONArray)o3);</b>
&nbsp;		} else {
&nbsp;			//logger.debug(getIndent()+&quot;if(false)&quot;);
<b class="nc">&nbsp;			parseScratchCode((JSONArray)o4);</b>
&nbsp;		}		
&nbsp;	}
&nbsp;
&nbsp;	private void doIf(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		if(resolveBoolean((JSONArray)o2)) {</b>
&nbsp;			//logger.debug(getIndent()+&quot;if(true)&quot;);
<b class="nc">&nbsp;			parseScratchCode((JSONArray)o3);</b>
&nbsp;		}		
&nbsp;	}
&nbsp;
&nbsp;	private void doUntil(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
&nbsp;		//logger.debug(getIndent()+&quot;Do Until&quot;);
<b class="nc">&nbsp;		while(!resolveBoolean((JSONArray)o2)) {</b>
<b class="nc">&nbsp;			parseScratchCode((JSONArray)o3);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void doRepeat(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		int count = (int)resolveValue(o2);</b>
&nbsp;		//logger.debug(getIndent()+&quot;Repeat &quot;+count+&quot; times:&quot;);
<b class="nc">&nbsp;		for(int i=0;i&lt;count;++i) {</b>
<b class="nc">&nbsp;			parseScratchCode((JSONArray)o3);</b>
&nbsp;		}		
&nbsp;	}
&nbsp;
&nbsp;	private void doBroadcastAndWait(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
&nbsp;		//logger.debug(getIndent()+&quot;broadcast &quot;+(String)o2);
<b class="nc">&nbsp;		JSONArray arr = subRoutines.get(o2);</b>
<b class="nc">&nbsp;		parseScratchCode(arr);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Scratch block contains a boolean or boolean operator
&nbsp;	 * @param obj a String, Number, or JSONArray of elements to be calculated. 
&nbsp;	 * @return the calculated final value.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private boolean resolveBoolean(Object obj) throws Exception {
<b class="nc">&nbsp;		if(!(obj instanceof JSONArray)) {</b>
<b class="nc">&nbsp;			throw new Exception(&quot;Parse error (resolveBoolean not array)&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		JSONArray arr=(JSONArray)obj;</b>
<b class="nc">&nbsp;		Iterator&lt;?&gt; scriptIter = arr.iterator();</b>
<b class="nc">&nbsp;		Object first = scriptIter.next();</b>
<b class="nc">&nbsp;		String name = first.toString();</b>
<b class="nc">&nbsp;		if(name.equals(&quot;&gt;&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;			double a = resolveValue(o2);</b>
<b class="nc">&nbsp;			double b = resolveValue(o3);</b>
<b class="nc">&nbsp;			return a &gt; b;</b>
&nbsp;		}
<b class="nc">&nbsp;		if(name.equals(&quot;&lt;&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;			double a = resolveValue(o2);</b>
<b class="nc">&nbsp;			double b = resolveValue(o3);</b>
<b class="nc">&nbsp;			return a &lt; b;</b>
&nbsp;		}
<b class="nc">&nbsp;		if(name.equals(&quot;=&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;			double a = resolveValue(o2);</b>
<b class="nc">&nbsp;			double b = resolveValue(o3);</b>
<b class="nc">&nbsp;			return a == b; </b>
&nbsp;		}
<b class="nc">&nbsp;		if(name.equals(&quot;not&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			return !resolveBoolean(o2);</b>
&nbsp;		}
<b class="nc">&nbsp;		if(name.equals(&quot;&amp;&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;			return resolveBoolean(o2) &amp;&amp; resolveBoolean(o3);</b>
&nbsp;		}
<b class="nc">&nbsp;		if(name.equals(&quot;|&quot;)) {</b>
<b class="nc">&nbsp;			Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;			Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;			return resolveBoolean(o2) || resolveBoolean(o3);</b>
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		throw new Exception(&quot;Parse error (resolveBoolean unsupported)&quot;);</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Scratch block contains an Operator (variable, constant, or math combination of the two). 
&nbsp;	 * @param obj a String, Number, or JSONArray of elements to be calculated.
&nbsp;	 * @return the calculated final value.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private double resolveValue(Object obj) throws Exception {
<b class="nc">&nbsp;		if(obj instanceof String) {</b>
&nbsp;			// probably a variable
<b class="nc">&nbsp;			String firstName = obj.toString();</b>
<b class="nc">&nbsp;			if(firstName.equals(&quot;xpos&quot;)) return turtle.getX();</b>
<b class="nc">&nbsp;			if(firstName.equals(&quot;ypos&quot;)) return turtle.getY();</b>
<b class="nc">&nbsp;			if(firstName.equals(&quot;heading&quot;)) return turtle.getAngle();</b>
&nbsp;
&nbsp;			try {
<b class="nc">&nbsp;				float v = Float.parseFloat(firstName);</b>
<b class="nc">&nbsp;				return v;</b>
<b class="nc">&nbsp;			} catch (Exception e) {</b>
<b class="nc">&nbsp;				throw new Exception(&quot;Unresolved string value &#39;&quot;+obj.toString()+&quot;&#39;&quot;, e);</b>
&nbsp;			}
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		if(obj instanceof Number) {</b>
<b class="nc">&nbsp;			Number num = (Number)obj;</b>
<b class="nc">&nbsp;			return (double)num.doubleValue();</b>
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		if(obj instanceof JSONArray) {</b>
<b class="nc">&nbsp;			JSONArray arr=(JSONArray)obj;</b>
<b class="nc">&nbsp;			Iterator&lt;?&gt; scriptIter = arr.iterator();</b>
<b class="nc">&nbsp;			Object first = scriptIter.next();</b>
<b class="nc">&nbsp;			if(!(first instanceof String)) {</b>
<b class="nc">&nbsp;				throw new Exception(&quot;Parse error (resolveValue array)&quot;);</b>
&nbsp;			}
<b class="nc">&nbsp;			String firstName = first.toString();</b>
<b class="nc">&nbsp;			switch(firstName) {</b>
<b class="nc">&nbsp;			case &quot;/&quot; : 						return doDivide(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;*&quot; : 						return doMultiply(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;+&quot; : 						return doAdd(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;-&quot; : 						return doSubtract(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;%&quot; : 						return doModulus(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;randomFrom:to:&quot; : 		return doRandom(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;readVariable&quot; : 			return doReadVariable(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;computeFunction:of:&quot; : 	return doCompute(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;lineCountOfList:&quot; : 		return doCountList(scriptIter);</b>
<b class="nc">&nbsp;			case &quot;getLine:ofList:&quot; : 		return doGetFromList(scriptIter);</b>
<b class="nc">&nbsp;			default :						logger.debug(&quot;unknown operation &quot;+firstName);</b>
&nbsp;			}
&nbsp;			
<b class="nc">&nbsp;			return resolveValue(first);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		throw new Exception(&quot;Parse error (resolveValue)&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private double doGetFromList(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		Object o2 = scriptIter.next();</b>
<b class="nc">&nbsp;		Object o3 = scriptIter.next();</b>
<b class="nc">&nbsp;		int listIndex = resolveListIndex(o2,o3);</b>
<b class="nc">&nbsp;		String listName = (String)o3;</b>
<b class="nc">&nbsp;		Scratch2List list = scratchLists.get(getListByID(listName)); </b>
&nbsp;
<b class="nc">&nbsp;		return list.contents.get(listIndex);</b>
&nbsp;	}
&nbsp;
&nbsp;	private double doCountList(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		String listName = (String)scriptIter.next();</b>
<b class="nc">&nbsp;		return scratchLists.get(getListByID(listName)).contents.size();</b>
&nbsp;	}
&nbsp;
&nbsp;	private double doCompute(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		String functionName = (String)scriptIter.next();</b>
<b class="nc">&nbsp;		double a = (float)resolveValue(scriptIter.next());</b>
&nbsp;
<b class="nc">&nbsp;		switch(functionName) {</b>
<b class="nc">&nbsp;		case &quot;abs&quot; :		return Math.abs(a);</b>
<b class="nc">&nbsp;		case &quot;floor&quot; :		return Math.floor(a);</b>
<b class="nc">&nbsp;		case &quot;ceiling&quot; :	return Math.ceil(a);</b>
<b class="nc">&nbsp;		case &quot;sqrt&quot; :		return Math.sqrt(a);</b>
<b class="nc">&nbsp;		case &quot;sin&quot; :		return Math.sin(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;cos&quot; :		return Math.cos(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;tan&quot; :		return Math.tan(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;asin&quot; :		return Math.asin(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;acos&quot; :		return Math.acos(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;atan&quot; :		return Math.atan(Math.toRadians(a));</b>
<b class="nc">&nbsp;		case &quot;ln&quot; :			return Math.log(a);</b>
<b class="nc">&nbsp;		case &quot;log&quot; :		return Math.log10(a);</b>
<b class="nc">&nbsp;		case &quot;e ^&quot; :		return Math.pow(Math.E,a);</b>
<b class="nc">&nbsp;		case &quot;10 ^&quot; :		return Math.pow(10,a);</b>
<b class="nc">&nbsp;		default : 			throw new Exception(&quot;doCompute unknown operation &quot;+functionName);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private double doReadVariable(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		String varName = (String)scriptIter.next();</b>
&nbsp;
<b class="nc">&nbsp;		for(Scratch2Variable sv : scratchVariables) {</b>
<b class="nc">&nbsp;			if(sv.name.equals(varName)) return sv.value;</b>
&nbsp;		}
<b class="nc">&nbsp;		throw new Exception(&quot;Failed to find variable &quot;+varName);</b>
&nbsp;	}
&nbsp;
&nbsp;	private double doRandom(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		int a = (int)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		int b = (int)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		if(a&gt;b) {</b>
<b class="nc">&nbsp;			int c = b;</b>
<b class="nc">&nbsp;			b=a;</b>
<b class="nc">&nbsp;			a=c;</b>
&nbsp;		}
<b class="nc">&nbsp;		Random r = new Random();</b>
<b class="nc">&nbsp;		return r.nextInt(b-a)+a;</b>
&nbsp;	}
&nbsp;	
&nbsp;	private double doModulus(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		double a = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		double b = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		return a%b;</b>
&nbsp;	}
&nbsp;
&nbsp;	private double doDivide(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		double a = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		double b = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		return a/b;</b>
&nbsp;	}
&nbsp;	
&nbsp;	private double doMultiply(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		double a = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		double b = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		return a*b;</b>
&nbsp;	}
&nbsp;	
&nbsp;	private double doAdd(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		double a = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		double b = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		return a+b;</b>
&nbsp;	}
&nbsp;	
&nbsp;	private double doSubtract(Iterator&lt;?&gt; scriptIter) throws Exception {
<b class="nc">&nbsp;		double a = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		double b = (double)resolveValue(scriptIter.next());</b>
<b class="nc">&nbsp;		return a-b;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Find the requested index in a list.
&nbsp;	 * @param o2 the index value.  could be &quot;random&quot;, &quot;last&quot;, or an index number
&nbsp;	 * @param o3 the list name.
&nbsp;	 * @return the resolved value as an integer.
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private int resolveListIndex(Object o2,Object o3) throws Exception {
&nbsp;		int listIndex;
&nbsp;		
<b class="nc">&nbsp;		if(o2 instanceof String) {</b>
<b class="nc">&nbsp;			String index = (String)o2;</b>
<b class="nc">&nbsp;			String listName = (String)o3;</b>
<b class="nc">&nbsp;			Scratch2List list = scratchLists.get(getListByID(listName));</b>
<b class="nc">&nbsp;			if(index.equals(&quot;last&quot;)) {</b>
<b class="nc">&nbsp;				listIndex = list.contents.size()-1;</b>
<b class="nc">&nbsp;			} else if(index.equals(&quot;random&quot;)) {</b>
<b class="nc">&nbsp;				listIndex = (int) (Math.random() * list.contents.size());</b>
&nbsp;			} else {
<b class="nc">&nbsp;				listIndex = Integer.parseInt(index);</b>
&nbsp;			}
&nbsp;		} else {
<b class="nc">&nbsp;			listIndex = (int)resolveValue(o2);</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		return listIndex;</b>
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-10-07 20:00</div>
</div>
</body>
</html>
